<!DOCTYPE html><html lang="zh-tw"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Python获取Linux磁盘容量 · iLovebaicai</title><meta name="description" content="Python获取Linux磁盘容量 - Nemo Chen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="iLovebaicai"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/cfqtxd1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://messay.me/about/" target="_blank" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Python获取Linux磁盘容量</h1><div class="post-info">2016年12月12日</div><div class="post-content"><h4 id="使用cron服务-定时跑脚本-监控磁盘容量"><a href="#使用cron服务-定时跑脚本-监控磁盘容量" class="headerlink" title="使用cron服务,定时跑脚本,监控磁盘容量."></a>使用cron服务,定时跑脚本,监控磁盘容量.</h4><h4 id="Python脚本监控磁盘使用量-导入Mail模块-超过定值-邮件通知-附上参考脚本"><a href="#Python脚本监控磁盘使用量-导入Mail模块-超过定值-邮件通知-附上参考脚本" class="headerlink" title="Python脚本监控磁盘使用量,导入Mail模块,超过定值,邮件通知(附上参考脚本)"></a>Python脚本监控磁盘使用量,导入Mail模块,超过定值,邮件通知(附上参考脚本)</h4><a id="more"></a>
<hr>
<h4 id="Python磁盘操作模块"><a href="#Python磁盘操作模块" class="headerlink" title="Python磁盘操作模块"></a>Python磁盘操作模块</h4><h4 id="os-statvfs-函数"><a href="#os-statvfs-函数" class="headerlink" title="os.statvfs()函数"></a>os.statvfs()函数</h4><ul>
<li>系统中的df命令应该调用了linux的函数statfs()，这里我使用python，调用的是 os.statvfs()函数。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">需要的头文件</div><div class="line"></div><div class="line">imprt os     <span class="comment">#os模块，statvfs函数在此模块中</span></div><div class="line"><span class="keyword">import</span> statvfs     <span class="comment">#里面有相应的宏，F_BSIZE等，可以不需要。</span></div><div class="line"></div><div class="line">vfs=os.statvfs(“目录”)返回这个目录所在磁盘的信息。</div><div class="line"></div><div class="line">F_BSIZE = <span class="number">0</span> <span class="comment"># 首选block大小                Preferred file system block size</span></div><div class="line"></div><div class="line">F_FRSIZE = <span class="number">1</span> <span class="comment"># 基本文件block大小             Fundamental file system block size</span></div><div class="line"></div><div class="line">F_BLOCKS = <span class="number">2</span> <span class="comment">#文件系统block总数                       Total number of file system blocks (FRSIZE)</span></div><div class="line"></div><div class="line">F_BFREE = <span class="number">3</span> <span class="comment">#空闲block数量              Total number of free blocks</span></div><div class="line"></div><div class="line">F_BAVAIL = <span class="number">4</span> <span class="comment">#  非超级用户可用的block数量                Free blocks available to non-superuser</span></div><div class="line"></div><div class="line">F_FILES = <span class="number">5</span> <span class="comment"># 总的文件节点数量             Total number of file nodes</span></div><div class="line"></div><div class="line">F_FFREE = <span class="number">6</span> <span class="comment">#空闲的文件节点的数量                   Total number of free file nodes</span></div><div class="line"></div><div class="line">F_FAVAIL = <span class="number">7</span> <span class="comment">#非超级用户可用的空闲文件节点数量    Free nodes available to non-superuser</span></div><div class="line"></div><div class="line">F_FLAG = <span class="number">8</span> <span class="comment"># Flags (see your local statvfs man page)</span></div><div class="line"></div><div class="line">F_NAMEMAX = <span class="number">9</span> <span class="comment"># Maximum file name length</span></div></pre></td></tr></table></figure>
<ul>
<li><p>读取有多种方式，比如vfs[0],vfs.f_bsize,vfs[F_BSIZE]，都可以读取首选block大小的值。</p>
</li>
<li><p>计算容量就是 block大小*block数量</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#更改默认除法运算，使得除法计算得到float而不是int</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"></div><div class="line"><span class="comment">#获得磁盘信息</span></div><div class="line"></div><div class="line">vfs=os.statvfs(<span class="string">"目录"</span>)</div><div class="line"></div><div class="line"><span class="comment">#1k－blocks栏，总容量KB</span></div><div class="line"></div><div class="line">k_blocks=vfs.f_bsize*vfs.f_blocks/<span class="number">1024</span></div><div class="line"></div><div class="line"><span class="comment">#Used,使用量KB，总容量减去空闲容量</span></div><div class="line"></div><div class="line">used=vfs.f_bsize*(vfs.f_blocks-vfs.f_bfree)/<span class="number">1024</span></div><div class="line"></div><div class="line"><span class="comment">#Available，有效容量KB</span></div><div class="line"></div><div class="line">available=vfs.f_bsize*vfs.f_bavail/<span class="number">1024</span></div><div class="line"></div><div class="line"><span class="comment">#use%,使用量，%,round(浮点数，精确到小数点后的位数）</span></div><div class="line"></div><div class="line">use=round(used/(used+available)*<span class="number">100</span>,<span class="number">2</span>)</div><div class="line"> 为什么use不是由used/k_blocks</div></pre></td></tr></table></figure>
<ul>
<li><p>看上去，使用量/总容量 就是使用率，但是忽略了一点  总容量=使用量+未使用量+不可使用量</p>
</li>
<li><p>所以其实重点就是在于这个不可使用量，使用率=使用量/(使用量+未使用量)  才是正确的值。</p>
</li>
</ul>
<hr>
<h4 id="参考脚本"><a href="#参考脚本" class="headerlink" title="参考脚本:"></a>参考脚本:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">disk_stat</span><span class="params">()</span>:</span></div><div class="line">    hd = &#123;&#125;</div><div class="line">    disk = os.statvfs(<span class="string">"/var/lib/test"</span>)</div><div class="line">    disk1 = os.statvfs(<span class="string">"/"</span>)</div><div class="line"></div><div class="line">    disksize = disk.f_bsize * disk.f_blocks/(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)</div><div class="line">    used = disk.f_bsize * (disk.f_blocks - disk.f_bfree) / (<span class="number">1024</span> ** <span class="number">3</span>)</div><div class="line">    hd[<span class="string">'diskused'</span>] = format((used / float(disksize)), <span class="string">'.2f'</span>)</div><div class="line"></div><div class="line">    disksize1 = disk1.f_bsize * disk1.f_blocks/(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)</div><div class="line">    used1 = disk1.f_bsize * (disk1.f_blocks - disk1.f_bfree) / (<span class="number">1024</span> ** <span class="number">3</span>)</div><div class="line">    hd[<span class="string">'diskused1'</span>] = format((used1 / float(disksize1)), <span class="string">'.2f'</span>)</div><div class="line"></div><div class="line">    <span class="comment">#return used, disksize, diskused, used1, disksize1, diskused1</span></div><div class="line">    <span class="keyword">return</span> hd</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Email</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">import</span> smtplib</div><div class="line">    <span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</div><div class="line">    <span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line">    <span class="keyword">from</span> email.mime.application <span class="keyword">import</span> MIMEApplication</div><div class="line">    <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line">    user = <span class="string">'test@test.com'</span></div><div class="line">    pwd = <span class="string">'test'</span></div><div class="line">    to = [<span class="string">'test@test.com'</span>]</div><div class="line">    msg = MIMEMultipart()</div><div class="line">    msg[<span class="string">'Subject'</span>]  = <span class="string">'disk Exceed the limit, Please Process'</span></div><div class="line">    msg[<span class="string">'From'</span>] = user</div><div class="line">    msg[<span class="string">'To'</span>] = <span class="string">','</span>.join(to)</div><div class="line"></div><div class="line">    part = MIMEText(<span class="string">'test disk Exceed the limit, Please Process'</span>)</div><div class="line">    msg.attach(part)</div><div class="line"></div><div class="line"></div><div class="line">    server = smtplib.SMTP(<span class="string">'smtp.test.com'</span>)</div><div class="line">    server.login(user, pwd)</div><div class="line">    server.sendmail(user, to, msg.as_string())</div><div class="line">    server.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    hd = disk_stat()</div><div class="line">    <span class="keyword">if</span> hd[<span class="string">'diskused'</span>] &gt; <span class="number">0.75</span> <span class="keyword">or</span> hd[<span class="string">'diskused1'</span>] &gt; <span class="number">0.75</span>:</div><div class="line">        Email()</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/14/使用阿里云PythonSdk-调用API获取全部主机信息/" class="prev">上一篇</a><a href="/2016/12/10/crontab服务详解/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://messay.me">Nemo Chen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-91949407-1",'auto');ga('send','pageview');</script></body></html>