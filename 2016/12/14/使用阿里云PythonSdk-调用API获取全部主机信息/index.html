<!DOCTYPE html><html lang="zh-tw"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用阿里云PythonSdk,调用API获取全部主机信息 · iLovebaicai</title><meta name="description" content="使用阿里云PythonSdk,调用API获取全部主机信息 - Nemo Chen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://messay.me/atom.xml" title="iLovebaicai"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/cfqtxd1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lovebaicai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://messay.me/about/" target="_blank" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用阿里云PythonSdk,调用API获取全部主机信息</h1><div class="post-info">2016年12月14日</div><div class="post-content"><h4 id="这周有个需求-需要把阿里云上的服务器信息拉下来统计-但是阿里云的文档实在是写的太烂-无奈google-工单-处理ok"><a href="#这周有个需求-需要把阿里云上的服务器信息拉下来统计-但是阿里云的文档实在是写的太烂-无奈google-工单-处理ok" class="headerlink" title="这周有个需求,需要把阿里云上的服务器信息拉下来统计.但是阿里云的文档实在是写的太烂.无奈google+工单.处理ok!"></a>这周有个需求,需要把阿里云上的服务器信息拉下来统计.但是阿里云的文档实在是写的太烂.无奈google+工单.处理ok!</h4><h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料:"></a>参考资料:</h4><ul>
<li>SDK安装和示例请参考<a href="https://develop.aliyun.com/sdk/python?spm=5176.doc25699.2.2.B3LMph" target="_blank" rel="external">这里</a></li>
<li>API参数请参考<a href="https://help.aliyun.com/document_detail/25484.html?spm=5176.doc25506.3.2.E7cEyj" target="_blank" rel="external">这里</a></li>
<li>脚本参考<a href="http://www.cnblogs.com/wangxiaoqiangs/p/5369336.html" target="_blank" rel="external">这里</a>,自己根据需要有删改.</li>
</ul>
<a id="more"></a>
<hr>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法:"></a>使用方法:</h4><h4 id="第一步，需要初始化Client"><a href="#第一步，需要初始化Client" class="headerlink" title="第一步，需要初始化Client"></a>第一步，需要初始化Client</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> aliyunsdkcore <span class="keyword">import</span> client</div><div class="line"></div><div class="line">clt = client.AcsClient(<span class="string">'SFAW************'</span>,<span class="string">'Nc2nZ6dQoiqck0*************'</span>,</div><div class="line"><span class="string">'cn-hangzhou'</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>NOTE:DescribeInstancesRequest是调用你对应的API的模块.</p>
</blockquote>
<h4 id="第二步-初始化request。以ECS的DescribeRegionsRequest接口为例"><a href="#第二步-初始化request。以ECS的DescribeRegionsRequest接口为例" class="headerlink" title="第二步, 初始化request。以ECS的DescribeRegionsRequest接口为例:"></a>第二步, 初始化request。以ECS的DescribeRegionsRequest接口为例:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> aliyunsdkecs.request.v20140526 <span class="keyword">import</span> DescribeInstancesRequest</div><div class="line"></div><div class="line">request = DescribeInstancesRequest.DescribeInstancesRequest()</div><div class="line">request.set_PageSize(Number) <span class="comment"># 设置返回sizenumber</span></div><div class="line">request.set_PageNumber(Number) <span class="comment"># 设置返回pagenumber</span></div><div class="line">request.set_accept_format(<span class="string">'json'</span>) <span class="comment"># 设置返回格式</span></div></pre></td></tr></table></figure>
<blockquote>
<p>NOTE:DescribeInstancesRequest是调用你对应的API的模块.除了DescribeInstancesRequest参数,其它参数都需要用set_xxx来设置.</p>
</blockquote>
<h4 id="第三步-发起API调用"><a href="#第三步-发起API调用" class="headerlink" title="第三步, 发起API调用"></a>第三步, 发起API调用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result = clt.do_action(request) <span class="comment"># 默认返回第一页,10条数据,可用set调整</span></div></pre></td></tr></table></figure>
<h4 id="示例脚本"><a href="#示例脚本" class="headerlink" title="示例脚本"></a>示例脚本</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># coding: utf-8</div><div class="line"></div><div class="line">'''</div><div class="line">功能介绍：</div><div class="line">1、调用阿里云API，收集所有区域 ECS 信息</div><div class="line">2、将需要的数据整理、生成 Excel 文档</div><div class="line">3、关于阿里 sdk 的安装，api 的调用请参考阿里云官网</div><div class="line">4、xlsxwriter 请参考这里：http://xlsxwriter.readthedocs.org/</div><div class="line">'''</div><div class="line"></div><div class="line">import json, sys</div><div class="line"></div><div class="line">try:</div><div class="line">    from termcolor import colored</div><div class="line">    from xlsxwriter import workbook</div><div class="line">    from aliyunsdkcore import client</div><div class="line">    from aliyunsdkecs.request.v20140526 import DescribeInstancesRequest</div><div class="line">except ImportError as e:</div><div class="line">    print(colored('%s : %s' % ('Error', e), 'red'))</div><div class="line">    exit(9)</div><div class="line"></div><div class="line">reload(sys)</div><div class="line"></div><div class="line">sys.setdefaultencoding('utf8')</div><div class="line"></div><div class="line"></div><div class="line">def get_sys_info(key, secret, zone, page):</div><div class="line">    '''</div><div class="line">    1、获取该区域全部主机详细信息</div><div class="line">    2、参数：cn-qingdao、cn-hangzhou、cn-beijing 等</div><div class="line">    '''</div><div class="line">    # 与阿里云建立有效连接</div><div class="line">    clt = client.AcsClient(key, secret, zone)</div><div class="line">    # 获取该区域全部实例详细信息</div><div class="line">    request = DescribeInstancesRequest.DescribeInstancesRequest()</div><div class="line">    request.set_PageSize(100)</div><div class="line">    request.set_PageNumber(page)</div><div class="line">    # 将数据格式化成 json，默认为 XML</div><div class="line">    request.set_accept_format('json')</div><div class="line">    # 发起请求，获取数据</div><div class="line">    result = json.loads(clt.do_action(request)).get('Instances').get('Instance')</div><div class="line"></div><div class="line">    return result</div><div class="line"></div><div class="line"></div><div class="line">def format_data(data_info):</div><div class="line">    '''</div><div class="line">    从全部数据中整理出需要的数据</div><div class="line">    '''</div><div class="line">    result = []</div><div class="line"></div><div class="line">    for line in data_info:</div><div class="line">        data = (</div><div class="line">            line.get('InstanceId'),</div><div class="line">            line.get('ZoneId'),</div><div class="line">            line.get('HostName'),</div><div class="line">            line.get('InstanceName'),</div><div class="line">            line.get('PublicIpAddress').get('IpAddress'),</div><div class="line">            line.get('InnerIpAddress').get('IpAddress'),</div><div class="line">            line.get('Cpu'),</div><div class="line">            line.get('Memory'),</div><div class="line">            line.get('InternetMaxBandwidthOut'),</div><div class="line">            line.get('Status'),</div><div class="line">            line.get('CreationTime'),</div><div class="line">            line.get('ExpiredTime')</div><div class="line">        )</div><div class="line">        result.append(data)</div><div class="line"></div><div class="line">    return result</div><div class="line"></div><div class="line"></div><div class="line">def write_excel(file, data):</div><div class="line">    '''</div><div class="line">    1、设置 Excel 样式</div><div class="line">    2、将数据写入到 Excel 中</div><div class="line">    '''</div><div class="line">    # 生成 Excel 文件</div><div class="line">    work = workbook.Workbook(file)</div><div class="line">    # 建立工作表，表名默认</div><div class="line">    worksheet = work.add_worksheet()</div><div class="line">    # 设置字体加粗、字体大小</div><div class="line">    format_title = work.add_format(&#123;'bold': True, 'font_size': 16&#125;)</div><div class="line">    # 设置水平对齐、垂直对齐</div><div class="line">    format_title.set_align('center')</div><div class="line">    format_title.set_align('vcenter')</div><div class="line"></div><div class="line">    format_body = work.add_format(&#123;'font_size': 14&#125;)</div><div class="line">    # 设置样式，行高、列宽</div><div class="line">    worksheet.set_row(0, 25)</div><div class="line">    worksheet.set_column(0, 0, 30)</div><div class="line">    worksheet.set_column(1, 1, 20)</div><div class="line">    worksheet.set_column(2, 3, 28)</div><div class="line">    worksheet.set_column(4, 5, 25)</div><div class="line">    worksheet.set_column(6, 6, 12)</div><div class="line">    worksheet.set_column(7, 9, 16)</div><div class="line">    worksheet.set_column(10, 11, 25)</div><div class="line">    # 定义表头</div><div class="line">    title = (</div><div class="line">        '实例 ID',</div><div class="line">        '所在区域',</div><div class="line">        '主机名称',</div><div class="line">        '主机别名',</div><div class="line">        '公网地址',</div><div class="line">        '私网地址',</div><div class="line">        'CPU 核数',</div><div class="line">        '内存大小 MB',</div><div class="line">        '网络带宽 MB',</div><div class="line">        '运行状态',</div><div class="line">        '创建时间',</div><div class="line">        '过期时间'</div><div class="line">    )</div><div class="line"></div><div class="line">    row = 0</div><div class="line">    col = 0</div><div class="line">    # 表头写入文件，引用样式</div><div class="line">    for item in title:</div><div class="line">        worksheet.write(row, col, item, format_title)</div><div class="line">        col += 1</div><div class="line">    # 内容写入文件，引用样式</div><div class="line">    for line in data:</div><div class="line">        row += 1</div><div class="line">        col = 0</div><div class="line">        for key in line:</div><div class="line">            worksheet.write(row, col, str(key), format_body) #ip地址是list类型,需转换成str.</div><div class="line">            col += 1</div><div class="line"></div><div class="line">    work.close()</div><div class="line"></div><div class="line"></div><div class="line">def main():</div><div class="line">    key = 'key'</div><div class="line">    secret = 'secret'</div><div class="line">    zones = ['cn-qingdao', 'cn-hangzhou', 'cn-beijing', 'cn-shanghai] #根据需要修改</div><div class="line"></div><div class="line">    filename = './aliyunSystemToExcel.xlsx'</div><div class="line"></div><div class="line">    result = []</div><div class="line"></div><div class="line">    for zone in zones:</div><div class="line">        for page in range(1, 2): # 根据主机数量,设置page数</div><div class="line">            info = get_sys_info(key, secret, zone, page)</div><div class="line">            data = format_data(info)</div><div class="line"></div><div class="line">            [result.append(line) for line in data]</div><div class="line"></div><div class="line">    write_excel(filename, result)</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == '__main__':</div><div class="line">    main()</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/20/MySQL正则表达式匹配/" class="prev">上一篇</a><a href="/2016/12/12/Python获取Linux磁盘容量/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://messay.me">Nemo Chen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-91949407-1",'auto');ga('send','pageview');</script></body></html>